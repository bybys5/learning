<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="own.jadezhang.learning.apple.dao.base.IUserDAO">
    <cache-ref namespace="own.jadezhang.learning.apple.dao.base.IUserDAO"></cache-ref>
    <resultMap id="userWithArticles" type="own.jadezhang.learning.apple.domain.base.UserEx">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="sex" column="sex"/>
        <collection property="articles" javaType="ArrayList" ofType="own.jadezhang.learning.apple.domain.base.Article">
            <result property="id" column="article_id"/>
            <result property="name" column="article_name"/>
            <result property="comment" column="article_comment"/>
        </collection>
    </resultMap>

    <select id="getUserWithArticles" resultMap="userWithArticles" >
        SELECT u.*, a.id AS article_id,a.name AS article_name
        FROM user u LEFT JOIN article a ON u.id = a.uid
        <trim prefix="WHERE" prefixOverrides="AND | OR">
            <if test="condition.id!=null">
                AND u.id = #{condition.id}
            </if>
            <if test="condition.name!=null">
                AND u.name like CONCAT('%', #{condition.name} , '%')
            </if>
            <if test="condition.sex!=null">
                AND u.sex = #{condition.sex}
            </if>
        </trim>
    </select>

    <select id="getTopByArticles" resultType="own.jadezhang.learning.apple.domain.base.UserEx">
        SELECT
        USER.*,
        @curr_cnt := cnt AS articleCount,
        @rank :=IF(@prev_cnt &lt;&gt; @curr_cnt,@rank + 1,@rank) AS rank,
        @prev_cnt := @curr_cnt AS dummy
        FROM
        (
            SELECT
            u.*, COUNT(*) cnt
            FROM
            article a
            INNER JOIN USER u ON u.id = a.uid,(SELECT @curr_cnt :=0,@prev_cnt :=0,@rank := 0) r
            GROUP BY
            uid
            ORDER BY cnt DESC
            LIMIT ${limit}
        ) AS USER;
    </select>

</mapper>